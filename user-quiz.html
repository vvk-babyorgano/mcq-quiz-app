<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ClickUp Quiz</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="icon" type="image/png" href="image/favicon.png" />
    <style>
      /* --- EXISTING STYLES --- */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border-radius: 10px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        overflow: hidden;
      }
      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }
      .header h1 {
        font-size: 2em;
        margin-bottom: 10px;
      }
      .content {
        padding: 40px;
      }
      .section {
        margin-bottom: 30px;
      }
      .section h2 {
        color: #333;
        margin-bottom: 20px;
        font-size: 1.3em;
      }
      .form-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 8px;
        color: #555;
        font-weight: 600;
      }
      input[type="text"] {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 5px;
        font-size: 16px;
        font-family: inherit;
        transition: border-color 0.3s;
      }
      input[type="text"]:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }
      button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: transform 0.2s, box-shadow 0.2s;
        width: 100%;
      }
      button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }
      .logout-btn {
        background: #dc3545;
        width: auto;
        padding: 8px 20px;
        font-size: 14px;
        margin-top: 15px;
      }
      .logout-btn:hover {
        box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
      }
      .question-container {
        background: #f8f9fa;
        padding: 25px;
        border-radius: 8px;
        border-left: 4px solid #667eea;
      }
      .question-text {
        font-size: 1.2em;
        color: #333;
        margin-bottom: 20px;
        font-weight: 600;
      }
      .question-type-badge {
        display: inline-block;
        background: #667eea;
        color: white;
        padding: 4px 10px;
        border-radius: 15px;
        font-size: 0.75em;
        margin-bottom: 15px;
        font-weight: 600;
      }
      .options {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      /* Radio/Checkbox Styles */
      .option-radio,
      .option-checkbox {
        display: flex;
        align-items: center;
        padding: 15px;
        background: white;
        border: 2px solid #ddd;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s;
      }
      .option-radio:hover,
      .option-checkbox:hover {
        border-color: #667eea;
        background: #f0f2ff;
      }
      .option-radio input[type="radio"],
      .option-checkbox input[type="checkbox"] {
        width: auto;
        margin-right: 12px;
        cursor: pointer;
      }
      .option-radio.selected,
      .option-checkbox.selected {
        background: #e7f0ff;
        border-color: #667eea;
      }
      .option-label,
      .checkbox-label {
        font-weight: 500;
        color: #333;
        flex: 1;
        cursor: pointer;
      }

      /* --- NEW STYLES FOR FEEDBACK POPUP --- */
      .feedback-box {
        margin-top: 15px;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
        font-weight: bold;
        animation: fadeIn 0.5s ease-in-out;
      }
      .feedback-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .feedback-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .status-message {
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
        text-align: center;
        font-weight: 600;
      }
      .status-waiting {
        background: #fff3cd;
        color: #856404;
      }
      .status-active {
        background: #d4edda;
        color: #155724;
      }
      .status-submitted {
        background: #d1ecf1;
        color: #0c5460;
      }
      .hidden {
        display: none;
      }
      .form-section {
        background: #f8f9fa;
        padding: 25px;
        border-radius: 8px;
      }
      .participant-info {
        background: #e7f0ff;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .participant-details {
        flex: 1;
      }
      .participant-details p {
        margin: 5px 0;
        color: #333;
      }
      .participant-details strong {
        color: #667eea;
      }
      .progress-bar {
        background: #ddd;
        height: 8px;
        border-radius: 5px;
        margin-bottom: 20px;
        overflow: hidden;
      }
      .progress-fill {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        height: 100%;
        transition: width 0.3s;
      }

      @media (max-width: 600px) {
        .header h1 {
          font-size: 1.5em;
        }
        .content {
          padding: 20px;
        }
        button {
          padding: 10px 20px;
          font-size: 14px;
        }
        .participant-info {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üéØ ClickUp Quiz</h1>
        <p>Test your knowledge</p>
      </div>

      <div class="content">
        <div id="registrationSection" class="section">
          <div class="form-section">
            <h2>Register to Start Quiz</h2>
            <form id="registrationForm">
              <div class="form-group">
                <label>Full Name *</label>
                <input
                  type="text"
                  id="participantName"
                  placeholder="Enter your full name"
                  required
                />
              </div>
              <div class="form-group">
                <label>Department *</label>
                <input
                  type="text"
                  id="participantDept"
                  placeholder="Enter your department"
                  required
                />
              </div>
              <button type="submit">Join Quiz</button>
            </form>
          </div>
        </div>

        <div id="quizSection" class="section hidden">
          <div class="participant-info" id="participantInfo">
            <div class="participant-details">
              <p><strong>Name:</strong> <span id="displayName"></span></p>
              <p><strong>Department:</strong> <span id="displayDept"></span></p>
            </div>
            <button class="logout-btn" onclick="logoutParticipant()">
              Change User
            </button>
          </div>

          <div id="statusMessage" class="status-message status-waiting">
            ‚è≥ Waiting for quiz to start...
          </div>

          <div id="questionSection" class="hidden">
            <div class="progress-bar">
              <div
                class="progress-fill"
                id="progressFill"
                style="width: 0%"
              ></div>
            </div>

            <div class="question-container">
              <span class="question-type-badge" id="typeBadge"></span>
              <div class="question-text" id="questionText"></div>
              <div class="options" id="optionsContainer"></div>
            </div>

            <button id="submitBtn" style="margin-top: 20px">
              Submit Answer
            </button>

            <div id="feedbackResult" class="hidden"></div>

            <div
              id="submitStatus"
              style="margin-top: 10px; text-align: center; color: #666"
            ></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const supabaseUrl = "https://ggyusywsblhyrhbtpupt.supabase.co";
      const supabaseAnonKey =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdneXVzeXdzYmxoeXJoYnRwdXB0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxNjk1NDAsImV4cCI6MjA2ODc0NTU0MH0.HJyFrT9zm7qC2sQJN9WmubEOzauEU08OrclkkowoAl0";
      const supabase = window.supabase.createClient(
        supabaseUrl,
        supabaseAnonKey
      );

      let participantId = null;
      let currentQuestion = null;
      let lastRenderedQuestionId = null;
      let selectedAnswer = null;
      let selectedAnswers = [];
      let quizActive = false;
      let questionsTotal = 0;
      let currentQuestionNumber = 0;
      let hasAnswered = false;

      const STORAGE_KEYS = {
        PARTICIPANT_ID: "quiz_participant_id",
        PARTICIPANT_NAME: "quiz_participant_name",
        PARTICIPANT_DEPT: "quiz_participant_dept",
      };

      document
        .getElementById("registrationForm")
        .addEventListener("submit", registerParticipant);
      document
        .getElementById("submitBtn")
        .addEventListener("click", submitAnswer);
      window.addEventListener("DOMContentLoaded", checkExistingRegistration);

      function checkExistingRegistration() {
        const savedId = localStorage.getItem(STORAGE_KEYS.PARTICIPANT_ID);
        const savedName = localStorage.getItem(STORAGE_KEYS.PARTICIPANT_NAME);
        const savedDept = localStorage.getItem(STORAGE_KEYS.PARTICIPANT_DEPT);

        if (savedId && savedName && savedDept) {
          participantId = savedId;
          document.getElementById("displayName").textContent = savedName;
          document.getElementById("displayDept").textContent = savedDept;
          document
            .getElementById("registrationSection")
            .classList.add("hidden");
          document.getElementById("quizSection").classList.remove("hidden");

          setupRealtimeListeners();
          loadQuizState();
        } else {
          if (savedName)
            document.getElementById("participantName").value = savedName;
          if (savedDept)
            document.getElementById("participantDept").value = savedDept;
        }
      }

      async function registerParticipant(e) {
        e.preventDefault();
        const name = document.getElementById("participantName").value.trim();
        const dept = document.getElementById("participantDept").value.trim();

        if (!name || !dept) {
          alert("Please fill in all fields");
          return;
        }

        const { data, error } = await supabase
          .from("participants")
          .insert([
            {
              name: name,
              department: dept,
              created_at: new Date().toISOString(),
            },
          ])
          .select();

        if (error) {
          alert("Error registering: " + error.message);
          return;
        }

        participantId = data[0].id;
        localStorage.setItem(STORAGE_KEYS.PARTICIPANT_ID, participantId);
        localStorage.setItem(STORAGE_KEYS.PARTICIPANT_NAME, name);
        localStorage.setItem(STORAGE_KEYS.PARTICIPANT_DEPT, dept);

        document.getElementById("displayName").textContent = name;
        document.getElementById("displayDept").textContent = dept;
        document.getElementById("registrationSection").classList.add("hidden");
        document.getElementById("quizSection").classList.remove("hidden");

        setupRealtimeListeners();
        loadQuizState();
      }

      function logoutParticipant() {
        if (
          confirm(
            "Are you sure you want to change user? This will clear your registration."
          )
        ) {
          localStorage.clear();
          location.reload();
        }
      }

      function setupRealtimeListeners() {
        supabase
          .channel("quiz_state_user")
          .on(
            "postgres_changes",
            { event: "*", schema: "public", table: "quiz_state" },
            () => {
              loadQuizState();
            }
          )
          .subscribe();
      }

      async function loadQuizState() {
        const { data, error } = await supabase
          .from("quiz_state")
          .select("*")
          .eq("id", 1)
          .single();

        if (error || !data) {
          updateStatus("‚è≥ Waiting for quiz to start...");
          document.getElementById("questionSection").classList.add("hidden");
          return;
        }

        quizActive = data.is_active;

        if (quizActive && data.current_question_id) {
          loadCurrentQuestion(data.current_question_id);
        } else {
          updateStatus(
            quizActive ? "Quiz paused..." : "‚è≥ Waiting for quiz to start..."
          );
          document.getElementById("questionSection").classList.add("hidden");
          lastRenderedQuestionId = null;
        }
      }

      async function loadCurrentQuestion(questionId) {
        // Prevent blinking logic
        if (
          currentQuestion &&
          currentQuestion.id === questionId &&
          lastRenderedQuestionId === questionId
        ) {
          checkIfAnswered();
          return;
        }

        const { data, error } = await supabase
          .from("questions")
          .select("*")
          .eq("id", questionId)
          .single();

        if (error) {
          console.error("Error loading question:", error);
          return;
        }

        currentQuestion = data;
        questionsTotal = await getQuestionsCount();
        currentQuestionNumber = data.question_number;

        selectedAnswer = null;
        selectedAnswers = [];
        hasAnswered = false;

        document.getElementById("feedbackResult").classList.add("hidden");
        document.getElementById("feedbackResult").className = "hidden";

        displayQuestion();
        updateStatus("‚úì Quiz Active - Answer the question");
        document.getElementById("questionSection").classList.remove("hidden");

        checkIfAnswered();

        lastRenderedQuestionId = questionId;
      }

      async function getQuestionsCount() {
        const { count } = await supabase
          .from("questions")
          .select("*", { count: "exact" });
        return count || 0;
      }

      // --- HELPER TO GET ONLY VALID (NON-EMPTY) OPTIONS ---
      function getValidOptions() {
        // Maps the Label to the DB column name. Added up to 'F'
        const map = [
          { label: "A", key: "option_a" },
          { label: "B", key: "option_b" },
          { label: "C", key: "option_c" },
          { label: "D", key: "option_d" },
          { label: "E", key: "option_e" },
          { label: "F", key: "option_f" },
        ];

        // Filter: Key must exist in data AND value must not be empty string/null
        return map
          .filter((item) => {
            const val = currentQuestion[item.key];
            return val && val.trim() !== "";
          })
          .map((item) => {
            return { label: item.label, text: currentQuestion[item.key] };
          });
      }

      function displayQuestion() {
        if (!currentQuestion) return;

        document.getElementById(
          "questionText"
        ).textContent = `Q${currentQuestion.question_number}: ${currentQuestion.question_text}`;

        document.getElementById("submitBtn").disabled = false;
        document.getElementById("submitStatus").textContent = "";

        if (currentQuestion.question_type === "multiple_choice") {
          displayMultipleChoice();
        } else if (currentQuestion.question_type === "checkbox") {
          displayCheckbox();
        }

        const progress = (currentQuestionNumber / questionsTotal) * 100;
        document.getElementById("progressFill").style.width = progress + "%";
      }

      function displayMultipleChoice() {
        document.getElementById("typeBadge").textContent = "‚óØ Multiple Choice";

        // Use the new dynamic helper function
        const options = getValidOptions();

        const optionsHtml = options
          .map(
            (opt) => `
            <label class="option-radio" data-value="${opt.label}">
                <input type="radio" name="answer" value="${opt.label}" onchange="selectOption('${opt.label}')">
                <span class="option-label">${opt.label}) ${opt.text}</span>
            </label>
        `
          )
          .join("");

        document.getElementById("optionsContainer").innerHTML = optionsHtml;
      }

      function displayCheckbox() {
        document.getElementById("typeBadge").textContent = "‚òë Select Multiple";

        // Use the new dynamic helper function
        const options = getValidOptions();

        const optionsHtml = options
          .map(
            (opt) => `
            <label class="option-checkbox" data-value="${opt.label}">
                <input type="checkbox" name="answers" value="${opt.label}" onchange="toggleCheckbox('${opt.label}')">
                <span class="checkbox-label">${opt.label}) ${opt.text}</span>
            </label>
        `
          )
          .join("");

        document.getElementById("optionsContainer").innerHTML = optionsHtml;
      }

      function selectOption(value) {
        if (hasAnswered) return;

        selectedAnswer = value;
        document.querySelectorAll(".option-radio").forEach((el) => {
          if (el.getAttribute("data-value") === value) {
            el.classList.add("selected");
          } else {
            el.classList.remove("selected");
          }
        });
      }

      function toggleCheckbox(value) {
        if (hasAnswered) return;

        const checkboxLabel = document.querySelector(
          `.option-checkbox[data-value="${value}"]`
        );
        const checkbox = checkboxLabel.querySelector('input[type="checkbox"]');

        if (checkbox.checked) {
          checkboxLabel.classList.add("selected");
        } else {
          checkboxLabel.classList.remove("selected");
        }

        selectedAnswers = Array.from(
          document.querySelectorAll('input[name="answers"]:checked')
        ).map((el) => el.value);
      }

      async function submitAnswer() {
        if (
          currentQuestion.question_type === "multiple_choice" &&
          !selectedAnswer
        ) {
          alert("Please select an option");
          return;
        }
        if (
          currentQuestion.question_type === "checkbox" &&
          selectedAnswers.length === 0
        ) {
          alert("Please select at least one option");
          return;
        }

        document.getElementById("submitBtn").disabled = true;
        document.getElementById("submitStatus").textContent = "Submitting...";

        const insertData = {
          participant_id: participantId,
          question_id: currentQuestion.id,
          created_at: new Date().toISOString(),
        };

        if (currentQuestion.question_type === "multiple_choice") {
          insertData.selected_answer = selectedAnswer;
        } else if (currentQuestion.question_type === "checkbox") {
          insertData.selected_answers = selectedAnswers.join(",");
        }

        const { error } = await supabase.from("responses").insert([insertData]);

        if (error) {
          alert("Error submitting answer: " + error.message);
          document.getElementById("submitBtn").disabled = false;
          document.getElementById("submitStatus").textContent = "";
          return;
        }

        hasAnswered = true;
        document.getElementById("submitStatus").textContent = "";

        showFeedback();
      }

      function showFeedback() {
        const feedbackEl = document.getElementById("feedbackResult");
        feedbackEl.classList.remove("hidden");

        const correctVal = currentQuestion.correct_answer;

        let isCorrect = false;

        if (correctVal) {
          if (currentQuestion.question_type === "multiple_choice") {
            isCorrect = selectedAnswer === correctVal;
          } else {
            const correctArr = correctVal.split(",").sort().join(",");
            const selectedArr = selectedAnswers.sort().join(",");
            isCorrect = correctArr === selectedArr;
          }
        } else {
          console.warn(
            "No 'correct_answer' column found in currentQuestion data."
          );
        }

        if (isCorrect) {
          feedbackEl.className = "feedback-box feedback-success";
          feedbackEl.innerHTML = "‚úÖ Your answer is Correct!";
        } else {
          feedbackEl.className = "feedback-box feedback-error";
          feedbackEl.innerHTML = `‚ùå Wrong Answer.<br><small style="font-weight:normal">The correct answer was: ${
            correctVal || "Not set in DB"
          }</small>`;
        }
      }

      async function checkIfAnswered() {
        const { data } = await supabase
          .from("responses")
          .select("*")
          .eq("participant_id", participantId)
          .eq("question_id", currentQuestion.id)
          .single();

        if (data) {
          hasAnswered = true;
          document.getElementById("submitBtn").disabled = true;

          if (data.selected_answer) {
            selectedAnswer = data.selected_answer;
            document.querySelectorAll(".option-radio").forEach((el) => {
              if (el.getAttribute("data-value") === data.selected_answer) {
                el.classList.add("selected");
                el.querySelector("input").checked = true;
              }
            });
          }
          if (data.selected_answers) {
            selectedAnswers = data.selected_answers.split(",");
            const answers = data.selected_answers.split(",");
            answers.forEach((ans) => {
              const label = document.querySelector(
                `.option-checkbox[data-value="${ans}"]`
              );
              if (label) {
                label.classList.add("selected");
                label.querySelector("input").checked = true;
              }
            });
          }

          if (
            document
              .getElementById("feedbackResult")
              .classList.contains("hidden")
          ) {
            showFeedback();
          }
        }
      }

      function updateStatus(message) {
        const status = document.getElementById("statusMessage");
        if (message.includes("‚è≥"))
          status.className = "status-message status-waiting";
        else if (message.includes("‚úì"))
          status.className = "status-message status-active";
        else status.className = "status-message status-submitted";
        status.textContent = message;
      }

      setTimeout(loadQuizState, 500);
      setInterval(loadQuizState, 3000);
    </script>
  </body>
</html>
